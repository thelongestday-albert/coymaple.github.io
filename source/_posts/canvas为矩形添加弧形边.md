---
title: canvas为矩形添加弧形边
tags:
- canvas
- js
---

> 本文旨在说明使用canvas为矩形添加弧形边的原理，并不会涉及大量的代码，想直接研究代码的同学可以在这个[演示demo](http://coymaple.gitee.io/mydemo/rect-arc.html)页面直接查看源码。

最近在做公司的一个数据可视化项目，该项目有一个样式特别的导航栏，大体效果如下。

![](http://cdn.coymaple.com/QQ%E5%9B%BE%E7%89%8720200816110935.png)

<!-- more -->

因为要适配不同的屏幕，刚开始我的想法是让设计把A、B、C做成svg图片，整体用flex弹性布局，自适应剩余未分配空间。后来却发现，svg不能在高度不变的情况下横向伸缩，尝试多次结果都是等比缩放。

SVG不能用，自然而然地想到了使用 canvas 来绘制图像。直线没什么好说的，很简单，绘制矩形的弧形边的时候却进展缓慢，首先尝试的是 **arcTo** 函数，但始终没有get到这个函数的正确用法，没能画出我想要的弧线。接着尝试使用 **arc** 函数，该函数有6个参数，前5个是必需的，前三个参数圆心坐标和半径通过本项目的隐藏条件很容易就可以得到。

隐藏条件：
- ① A、B、C的圆弧所在的圆和圆D是同心圆；
- ② A、B、C、D的中心在同一条水平线上。

通过以上两个条件可以很方便地求出圆心的坐标，半径则符合 r=r<sub>D</sub>+10 规律。

接下来就是求角度的问题了，这个困扰了我好几天，后来从一些数学题中得到启发，发现可以用反三角函数求a、b两点间的夹角。

在本项目中A、B、C上下两部分的高度是已知的，首先可以通过圆的标准方程 （(x-a)²+(y-b)²=r²）算出 b 点的横坐标。需要注意的是在圆上纵坐标相同的点有两个，可以根据矩形的长度范围进行取舍。

> 在js中，Math.sqrt() 可以求解参数的平方根，不过结果都是整数，需要自行判断符号。

再根据两点间的距离公式，可以求得a、b两点间的距离d的长度，直线ab是圆弧ab所在圆上的一条弦，过圆心作一条直线使其垂直于弦ab，其交点是弦ab的中点，根据三角函数和反三角函数可求得夹角θ的值，乘以2就是圆弧ab对应的弧度值。如下图所示：

> js中反正弦函数 Math.asin() 得到的值是弧度制的。同理，Math.sin() 的参数也应该是弧度制的。

![](http://cdn.coymaple.com/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20200816194611.jpg)

arc函数的弧度是从圆的三点钟方向开始算起的，所以还要连接a点和R点，用上面同样的方法获取夹角，这样就可以计算用来绘制弧线的起始角度和结束角度了。值得一提的是R点有可能在a,b两点之间，这时要调用两次arc函数分别绘制ar和rb两点的弧线。

![](http://cdn.coymaple.com/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20200816194623.jpg)


最后，在使用canvas绘制图像的时候注意路径的绘制方向，保证都是顺时针或者都是逆时针，这样填充颜色的时候才能如我们所想地将颜色填充进路径围成的图形内部。

<!-- lineTo 和 arc 函数都会将画笔移动到绘制子路径的终点座标处，不需要每次绘制一条弧线都执行一下 moveTo 函数。 -->

